
# Контракт взаимодействия: Бэкенд ↔ Фронтенд  
**Проект**: Web-приложение для прогнозирования самовозгорания угля при открытом хранении  
**Дата**: 22 ноября 2025 г.  
**Стороны**:  
- Бэкенд-разработчик (Эд)  
- Фронтенд-разработчик (Лена)  

## 1. Цель контракта  
Определить HTTP API, форматы данных и поведение бэкенда для корректной интеграции с фронтенд-частью веб-приложения.

## 2. Обязанности фронтенд-разработчика

### 2.1. Использование API  
Фронтенд использует **только следующие эндпоинты**, описанные в разделе 3. Любые другие маршруты считаются внутренними и нестабильными.

### 2.2. Отправка данных  
Фронтенд отправляет файлы в формате `multipart/form-data` с полем `file`, содержащим CSV-файл с корректной структурой (как в исходных данных хакатона).  
Также указывает тип данных через поле `data_type`.

### 2.3. Отображение данных  
Фронтенд:
- Отображает календарь рисков с цветовой индикацией.
- Показывает графики температуры и прогнозов.
- Визуализирует метрики качества модели в разделе аналитики.
- Указывает точное количество дней без пожаров.

### 2.4. Обработка ошибок  
Фронтенд обрабатывает HTTP-статусы:
- `400 Bad Request` — показывает сообщение об ошибке формата данных.
- `500 Internal Server Error` — показывает уведомление о технической проблеме.

## 3. Обязанности бэкенд-разработчика

Бэкенд предоставляет следующие **публичные эндпоинты**, доступные по адресу `http://localhost:8000`:

### 3.1. `POST /api/data`  
**Назначение**: Загрузка CSV-файлов с новыми данными.  
**Запрос**:  
- Content-Type: `multipart/form-data`  
- Поля:
  - `file`: CSV-файл
  - `data_type`: строка, одно из:
    - `"temperatures"` → данные из `temperature.csv`
    - `"fires"` → данные из `fires.csv`
    - `"supplies"` → данные из `supplies.csv`  
**Ответ (202 Accepted)**:
```json
{
  "status": "success",
  "message": "Данные типа '{data_type}' приняты. Прогноз обновляется."
}
```

### 3.2. `GET /api/predict`  
**Назначение**: Получение прогноза риска.  
**Query-параметры (опционально)**:
- `pile_id`: int — если нужно получить прогноз только для одного штабеля
- `date`: str (YYYY-MM-DD) — дата прогноза (по умолчанию — сегодня)  
**Ответ (200 OK)**:
```json
{
  "pile_id": 1,
  "forecast_date": "2025-11-22",
  "risk_levels": {
    "day_1": "low",
    "day_2": "medium",
    "day_3": "high"
  },
  "probabilities": {
    "day_1": 0.12,
    "day_2": 0.45,
    "day_3": 0.81
  }
}
```
> Если `pile_id` не указан — возвращается список прогнозов для всех активных штабелей.

### 3.3. `GET /api/dashboard`  
**Назначение**: Получение данных для главного экрана (Use Case UC1).  
**Ответ (200 OK)**:
```json
{
  "piles": [
    {
      "pile_id": 1,
      "coal_type": "A1",
      "formation_date": "2025-10-01",
      "days_in_storage": 52,
      "last_temp": 38.6,
      "risk_forecast": {
        "2025-11-22": "low",
        "2025-11-23": "medium",
        "2025-11-24": "high"
      }
    }
  ],
  "weather_summary": {
    "temp_avg": 5.2,
    "humidity": 78
  },
  "days_without_fire": 42,
  "last_update": "2025-11-22T10:00:00Z"
}
```

### 3.4. `GET /api/analytics`  
**Назначение**: Получение метрик качества модели и сравнения с реальностью.  
**Ответ (200 OK)**:
```json
{
  "metrics": {
    "precision": 0.35,
    "recall": 0.72,
    "f1_score": 0.47,
    "pr_auc": 0.58
  },
  "fire_events": [
    {
      "pile_id": 15,
      "actual_date": "2025-11-20",
      "predicted_interval": ["2025-11-17", "2025-11-19"],
      "hit": true
    }
  ]
}
```
### 3.5. `GET /api/pile/{pile_id}/history`  
**Назначение**: История температуры и прогнозов по штабелю.  
**Параметр**: `pile_id` — целое число  
**Ответ (200 OK)**:
```json
{
  "pile_id": 43,
  "coal_type": "A1",
  "formation_date": "2025-10-01",
  "days_in_storage": 52,
  "last_temp": 40.1,
  "temperature_history": [
    {"date": "2025-11-10", "temp": 32.1},
    {"date": "2025-11-12", "temp": 33.5},
    {"date": "2025-11-15", "temp": 35.7},
    {"date": "2025-11-18", "temp": 38.2},
    {"date": "2025-11-20", "temp": 40.1}
  ],
  "risk_history": [
    {"date": "2025-11-15", "level": "low", "probability": 0.08},
    {"date": "2025-11-18", "level": "medium", "probability": 0.35},
    {"date": "2025-11-20", "level": "high", "probability": 0.78},
    {"date": "2025-11-22", "level": "high", "probability": 0.85}
  ]
}
```

> ⚠️ Примечание:  
> - `last_temp` — последнее значение из `temperature_history` (для удобства UI).  
> - `days_in_storage` — рассчитывается как разница между `formation_date` и текущей датой.  
> - Все даты в формате `YYYY-MM-DD`.

## 4. Общие требования

- Все даты передаются в формате **ISO 8601** (`YYYY-MM-DD` или `YYYY-MM-DD HH:mm:ss`).
- Все текстовые поля — в кодировке UTF-8.
- CORS настроен для `http://localhost:3000` (React) и `http://localhost:8501` (Streamlit).
- Аутентификация и авторизация **не реализуются** в рамках MVP.
- Максимальное время ответа на любой запрос — **5 секунд**.
- При ошибке валидации CSV — возвращается `400 Bad Request` с JSON-описанием ошибки.
---
